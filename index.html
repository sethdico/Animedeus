<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animedeus</title>
    <style>
        :root {
            --primary-color: #B20710;
            --secondary-color: #1E1E1E;
            --background-color: #121212;
            --text-color: #E0E0E0;
            --button-color: #2A2A2A;
            --button-hover-color: #B20710;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        h1, h2 {
            text-align: center;
            color: var(--primary-color);
            margin: 10px 0;
        }

        h1 { font-size: 2rem; }
        h2 { font-size: 1.5rem; }

        .search-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 25px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        button {
            background-color: var(--button-color);
            color: var(--text-color);
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background-color: var(--button-hover-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        #result {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: 10px;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            background-color: #000000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        #videoPlayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid var(--primary-color);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .control-button {
            width: 48%;
            padding: 12px 20px;
            background-color: var(--button-color);
            color: var(--text-color);
            text-decoration: none;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background-color: var(--button-hover-color);
            transform: translateY(-2px); }

        #searchResults {
            background-color: var(--secondary-color);
            border-radius: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            position: relative;
            width: 100%;
        }

        .search-result {
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .search-result:hover {
            background-color: var(--button-hover-color);
        }

        #closeResults {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--button-color);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            line-height: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #closeResults:hover {
            background-color: var(--button-hover-color);
            transform: scale(1.1);
        }

        .episode-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
        }

        .episode-button {
            width: 40px;
            height: 40px;
            background-color: var(--button-color);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }

        .episode-button:hover {
            background-color: var(--button-hover-color);
            transform: scale(1.1);
        }

        .episode-button.current-episode {
            background-color: var(--primary-color);
            font-weight: bold;
        }

        #alternativeLink {
            text-align: center;
            margin-top: 15px;
        }

        #alternativeLink a {
            color: var(--primary-color);
            text-decoration: none;
        }

        #alternativeLink a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="videoContainer">
            <iframe id="videoPlayer" frameborder="0" allowfullscreen></iframe>
        </div>

        <div class="controls">
            <button id="prevEpisode" class="control-button">Previous</button>
            <button id="nextEpisode" class="control-button">Next</button>
        </div>

        <div id="episodeButtons" class="episode-buttons-container"></div>

        <h1>Animedeus</h1>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search anime">
            <button onclick="searchMAL()">Search</button>
        </div>
        <div id="searchResults"></div>

        <div class="search-container">
            <input type="text" id="malId" placeholder="MAL ID">
            <input type="number" id="episode" placeholder="Episode">
            <select id="dubSub">
                <option value="sub">Sub</option>
                <option value="dub">Dub</option>
            </select>
            <button onclick="loadAnime()">Load Anime</button>
        </div>

        <div id="result"></div>

        <div id="alternativeLink">
            <a href="https://www.miruro.tv" target="_blank">If error, you can use this website: www.miruro.tv</a>
        </div>
    </div>

    <script>
        let currentEpisode = 1;
        let currentAnimeTitle = '';
        let currentAnimeEnglishTitle = '';
        let currentAnimeJapaneseTitle = '';
        let totalEpisodes = 0;
        let currentAnimeId = '';
        let animeDetails = null;

        const searchMAL = async () => {
            const searchTerm = document.getElementById('searchInput').value;
            let data = getCachedSearchResults(searchTerm);

            if (!data) {
                data = await fetchWithErrorHandling(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(searchTerm)}&limit=5`);
                if (data) {
                    cacheSearchResults(searchTerm, data);
                }
            }

            if (data) {
                displaySearchResults(data);
            }
        };

        const closeSearchResults = () => {
            document.getElementById('searchResults').innerHTML = '';
        };

        const loadAnime = async () => {
            showLoading();
            const malId = document.getElementById('malId').value;
            currentEpisode = parseInt(document.getElementById('episode').value ) || 1;

            try {
                animeDetails = await fetchAnimeDetails(malId);
                if (animeDetails) {
                    currentAnimeTitle = animeDetails.title;
                    currentAnimeEnglishTitle = animeDetails.title_english || animeDetails.title;
                    currentAnimeJapaneseTitle = animeDetails.title_japanese || animeDetails.title;
                    totalEpisodes = animeDetails.episodes;
                    generateEpisodeButtons(totalEpisodes);
                    currentAnimeId = malId;
                    updatePlayer();
                }
            } catch (error) {
                console.error("Error loading anime:", error);
                showError("An error occurred while loading the anime. Please try again.");
            }
        };

        const fetchAnimeDetails = async (malId) => {
            const response = await fetch(`https://api.jikan.moe/v4/anime/${malId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            } else {
                const data = await response.json();
                return data.data;
            }
        };

        const generateEpisodeButtons = (totalEpisodes) => {
            const episodeButtonsContainer = document.getElementById('episodeButtons');
            episodeButtonsContainer.innerHTML = '';

            for (let i = 1; i <= totalEpisodes; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.classList.add('episode-button');
                button.onclick = () => {
                    currentEpisode = i;
                    updatePlayer();
                };
                episodeButtonsContainer.appendChild(button);
            }
        };

        const updatePlayer = async () => {
            const dubSub = document.getElementById('dubSub').value;
            const url = `https://vidlink.pro/anime/${currentAnimeId}/${currentEpisode}/${dubSub}`;
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.src = url;

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h2>Now Playing</h2>
                <p><strong>Title:</strong> ${currentAnimeEnglishTitle}; ${currentAnimeJapaneseTitle}</p>
                <p><strong>MAL ID:</strong> ${animeDetails.mal_id}</p>
                <p><strong>Episode:</strong> ${currentEpisode}</p>
                <p><strong>Type:</strong> ${dubSub}</p>
                <p><strong>Year:</strong> ${animeDetails.year || 'N/A'}</p>
                <p><strong>Studios:</strong> ${animeDetails.studios.map(studio => studio.name).join(', ') || 'N/A'}</p>
                <p><strong>Genres:</strong> ${animeDetails.genres.map(genre => genre.name).join(', ') || 'N/A'}</p>
                <p><strong>Synopsis:</strong> ${animeDetails.synopsis || 'N/A'}</p>
            `;

            document.getElementById('episode').value = currentEpisode;

            const episodeButtons = document.querySelectorAll('.episode-button');
            episodeButtons.forEach(button => {
                if (parseInt(button.textContent) === currentEpisode) {
                    button.classList.add('current-episode');
                } else {
                    button.classList.remove('current-episode');
                }
            });
        };

        const changeEpisode = (delta) => {
            currentEpisode += delta;
            if (currentEpisode < 1) currentEpisode = 1;
            if (currentEpisode > totalEpisodes) currentEpisode = totalEpisodes;
            updatePlayer();
        };

        document.getElementById('prevEpisode').addEventListener('click', () => changeEpisode(-1));
        document.getElementById('nextEpisode').addEventListener('click', () => changeEpisode(1));

        const fetchWithErrorHandling = async (url) => {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Could not fetch data:", error);
                showError("An error occurred while fetching data. Please try again later.");
            }
        };

        const showError = (message) => {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<p style="color: red;">${message}</p>`;
        };

        const cacheSearchResults = (searchTerm, results) => {
            localStorage.setItem(`search_${searchTerm}`, JSON.stringify(results));
        };

        const getCachedSearchResults = (searchTerm) => {
            return JSON.parse(localStorage.getItem(`search_${searchTerm}`));
        };

        const showLoading = () => {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Loading...</p>';
        };

        const displaySearchResults = (data) => {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '<button id="closeResults" onclick="closeSearchResults()">×</button>';

            data.data.forEach(anime => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'search-result';
                resultDiv.textContent = `${anime.title} (${anime.title_english || anime.title}) (ID: ${anime.mal_id})`;
                resultDiv.onclick = () => {
                    document.getElementById('malId').value = anime.mal_id;
                    document.getElementById('searchInput').value = anime.title;
                    currentAnimeTitle = anime.title;
                    currentAnimeEnglishTitle = anime.title_english || anime.title;
                    currentAnimeJapaneseTitle = anime.title_japanese || anime.title;
                    closeSearchResults();
                };
                searchResults.appendChild(resultDiv);
            });
        };
    </script>
</body>
</html>
